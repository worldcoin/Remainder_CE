name: master-pull
run-name: CI/CD Pipeline to run on merge to master
on:
  push:
    branches: master
  pull_request:
    branches: master
jobs:
  check_and_test:
    name: Compile and check formatting/linting.
    runs-on: [self-hosted, amd64, rust]
    steps:
      - uses: actions/checkout@v2
      - uses: actions-rs/toolchain@v1
      - name: Run 'make check'
        run: make check

  fmt_and_lint:
    name: Run tests
    runs-on: [self-hosted, amd64, rust]
    steps:
      - uses: actions/checkout@v2
      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
      - name: Run 'make test'
        run: make test

  mem_limit_test:
    name: Memory Limit Test
    runs-on: [self-hosted, amd64, rust]
    steps:
      - uses: actions/checkout@v2
      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
      - name: Install cgroup-tools
        run: sudo apt-get update && sudo apt-get install cgroup-tools
      - name: Run 'make mem-lim'
        run: make mem-lim
